---
title: "Multiple regression: TRELIS-Q WP5 data"
author: "Niklas Karlsen"
date: "2024-04-02"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), '../output/bookchapter.TRELIS-Q-WP5.html')) })
---

# Initialize

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) #,results="asis")

Sys.setenv(LANG = "no_NB.UTF-8")            # for norwegian æ,ø og å. Kilde:
Sys.setlocale("LC_ALL","Norwegian")
# https://stackoverflow.com/questions/16347731/how-to-change-the-locale-of-r

plot_to_file = 1
```

## Load libraries

```{r load_libraries, echo=FALSE, warning=FALSE, message=FALSE}
#library(pander)                             # prettyprint for tables
library(plyr)
library(ggplot2)
library(viridis)

library(mice)                               # for md.pattern (missing)
library(psych)                              # for ICC, SD

# cluster-variable
# kilde: https://www.r-bloggers.com/2021/05/clustered-standard-errors-with-r/
library(estimatr)                           # for cluster corrected SE
#library(sandwich)
#library(lmtest)
```

## Help functions

```{r}
# describe data (mean, sd, skew, curtosis)
describe_data <- function (datalist, QUIET=1) {
  im <- mean(datalist, na.rm=TRUE)
  isd <- sd(datalist, na.rm=TRUE)
  isk <- psych::skew(datalist, na.rm=TRUE) # from psych
  ik <- kurtosi(datalist, na.rm=TRUE) # from psych
  mis <- sum(is.na(datalist)) # missing
  ir <- max(datalist, na.rm=TRUE) -          
    min(datalist, na.rm=TRUE) # range
  
  # source: https://stackoverflow.com/questions/34351598/getting-name-of-variable-in-r
  if (QUIET != 1) {
    print(sprintf("%7s = %s", "Item", deparse(substitute(datalist))))
    print(sprintf("%7s = %.3f", "mean", im))
    print(sprintf("%7s = %.3f", "std.dev", isd))
    print(sprintf("%7s = %.3f", "skew", isk))
    print(sprintf("%7s = %.3f", "kurt", ik))
    print(sprintf("%7s = %.3f", "range", ir))
    print(sprintf("%7s = %i", "missing", mis))

    if (isk > 2 | ik > 7) {
      print("                            Skew or curtosis TOO LARGE.")
    }
  }
  
  # outliers
  lowerq = quantile(datalist, na.rm=TRUE)[2]
  upperq = quantile(datalist, na.rm=TRUE)[4]
  iqr = upperq - lowerq #Or use IQR(df)
  # gang med 3 for extreme outliers, 1.5 for mild outliers
  
  mild.threshold.upper = (iqr * 3) + upperq
  mild.threshold.lower = lowerq - (iqr * 3)
  
  # print outliers
  # kilde: https://stackoverflow.com/questions/19353116/how-do-i-print-values-in-a-list-that-are-greater-than-a-certain-number-along-wit#19353192
  outliers_upper <- which(datalist>mild.threshold.upper)
  outliersu <- datalist[outliers_upper]
  outliers_lower <- which(datalist<mild.threshold.lower)
  outliersl <- datalist[outliers_lower]
  
  if (length(outliersu) > 0 | length(outliersl) > 0) {
    print("outliers upper =")
    print(outliersu)
    print("outliers lower =")
    print(outliersl)
  }
  
  #hist (datalist, main=i) # histogram
  #readline(prompt = "Press enter")
  
  return(c("mean"=round(im,3), "skew"=round(isk,3), "kurtosi"=round(ik,3)))
           #round(outliersu,3), round(outliersl,3)))
}

###
# helper functions from http://www.cookbook-r.com/Graphs/Plotting_means_and_error_bars_(ggplot2)/
###

## Gives count, mean, standard deviation, standard error of the mean, and confidence interval (default 95%).
##   data: a data frame.
##   measurevar: the name of a column that contains the variable to be summariezed
##   groupvars: a vector containing names of columns that contain grouping variables
##   na.rm: a boolean that indicates whether to ignore NA's
##   conf.interval: the percent range of the confidence interval (default is 95%)
summarySE <- function(data=NULL, measurevar, groupvars=NULL, na.rm=FALSE,
                      conf.interval=.95, .drop=TRUE) {
  #library(plyr)
  
  # New version of length which can handle NA's: if na.rm==T, don't count them
  length2 <- function (x, na.rm=FALSE) {
    if (na.rm) sum(!is.na(x))
    else       length(x)
  }
  
  # This does the summary. For each group's data frame, return a vector with
  # N, mean, and sd
  datac <- ddply(data, groupvars, .drop=.drop,
                 .fun = function(xx, col) {
                   c(N    = length2(xx[[col]], na.rm=na.rm),
                     mean = mean   (xx[[col]], na.rm=na.rm),
                     sd   = sd     (xx[[col]], na.rm=na.rm)
                   )
                 },
                 measurevar
  )
  
  # Rename the "mean" column  ; from plyr package
  datac <- plyr::rename(datac, c("mean" = measurevar))
  #datac <- rename(datac, measurevar = "mean") # oppdatert til ny versjon av dplyr
  
  datac$se <- datac$sd / sqrt(datac$N)  # Calculate standard error of the mean
  
  # Confidence interval multiplier for standard error
  # Calculate t-statistic for confidence interval: 
  # e.g., if conf.interval is .95, use .975 (above/below), and use df=N-1
  ciMult <- qt(conf.interval/2 + .5, datac$N-1)
  datac$ci <- datac$se * ciMult
  
  return(datac)
}

## Norms the data within specified grupper in a data frame; it normalizes each
## subject (identified by idvar) so that they have the same mean, within each group
## specified by betweenvars.
##   data: a data frame.
##   idvar: the name of a column that identifies each subject (or matched subjects)
##   measurevar: the name of a column that contains the variable to be summariezed
##   betweenvars: a vector containing names of columns that are between-subjects variables
##   na.rm: a boolean that indicates whether to ignore NA's
normDataWithin <- function(data=NULL, idvar, measurevar, betweenvars=NULL,
                           na.rm=FALSE, .drop=TRUE) {
  #library(plyr)
  
  # Measure var on left, idvar + between vars on right of formula.
  data.subjMean <- ddply(data, c(idvar, betweenvars), .drop=.drop,
                         .fun = function(xx, col, na.rm) {
                           c(subjMean = mean(xx[,col], na.rm=na.rm))
                         },
                         measurevar,
                         na.rm
  )
  
  # Put the subject means with original data
  data <- merge(data, data.subjMean)
  
  # Get the normalized data in a new column
  measureNormedVar <- paste(measurevar, "_norm", sep="")
  data[,measureNormedVar] <- data[,measurevar] - data[,"subjMean"] +
    mean(data[,measurevar], na.rm=na.rm)
  
  # Remove this subject mean column
  data$subjMean <- NULL
  
  return(data)
}

```

## Define constructs 

```{r load_constructs}
## TPACK-PST for TRELIS-Q
TK_pos_trelisq    <- c("TK1b","TK2","TK34") 
PCK_pos_trelisq   <- c("CK123","CK5","PCK2","PCK5")
TPACK_pos_trelisq <- c("TPACK2","TPACK4","TCK1","TCK4","TPK1","TPK4") 

TPACK_PST_list    <- list(TK=TK_pos_trelisq,
                     PCK=PCK_pos_trelisq,
                     TPACK=TPACK_pos_trelisq)
```

# Data management

## Load data

```{r load_data_cfa}
# Rdata-file contains reduced / prepared datasets
load(file="../data/processed_data/tpack-TRELIS-Q_2023.Rdata")
```

## Prepare data

Flytt origo

```{r}
data_trelis_q_ren[,unlist(TPACK_PST_list)] <- data_trelis_q_ren[,unlist(TPACK_PST_list)] - 3 
```

OBS! Anonymiser data i datafil på studiested før det legges ut åpent på nett

```{r}
# identify NA as studiested 5(?) 
data_trelis_q_ren[data_trelis_q_ren$studiested == "Nord universitet","Trinn"] <- "Trinn 5-10"
```

## Check for missing

```{r}
# covariates
md.pattern(data_trelis_q_ren[,c("studiested","Gender", "Trinn", "semester")])

# items / likert data
md.pattern(data_trelis_q_ren[, unlist(TPACK_PST_list)])
```

```{r fix_missing, eval=T}
# remove NMAR + NTNU (19)
data_clean <- data_trelis_q_ren[-c(19,34,44,45,46,95,102),] 

# jeg skjuler Annet, siden det bare er en person; alternativt NA?
data_clean$Trinn[data_clean$Trinn == "Annet"] <- NA # "Trinn 5-10"
#trinn_r[is.na(trinn_r)] <- 1
  
# jeg skulet Annet / ønsker ikke å oppgi, siden det bare er to personer
# skjuler som Kvinne, siden det er flest av de
data_clean$Gender[data_clean$Gender == "Annet/ønsker ikke å oppgi"] <- NA # "Kvinne"
#gender_r[is.na(gender_r)] <- 1

# merge 2. and 3. year (Naturfag 1)
#data_clean$semester[data_clean$semester == "2. år"] <- "3. år"
```

# Descriptive statistics

```{r}
scores_v23 <- scoreItems(TPACK_PST_list, data_clean)

describe(scores_v23$scores)

# constructs for multiple regression
TK_v23    <- scores_v23$scores[,"TK"]
PCK_v23   <- scores_v23$scores[,"PCK"]
TPACK_v23 <- scores_v23$scores[,"TPACK"]

# add constructs to data.frame
data_clean$TK    <- TK_v23
data_clean$PCK   <- PCK_v23
data_clean$TPACK <- TPACK_v23
```

## Bargraphs: comparing institutes

```{r}
# group institutes into three: low, medium, high
data_clean$studiested2 <- factor(data_clean$studiested, 
                                 level=c("HVL","UiT","Nord universitet","Høgskolen i Innlandet","OsloMet"),
                                 label=c("A", "A", "B", "C", "C"))

dc1 <- summarySE(data_clean, measurevar="TK", groupvars="studiested2")
dc2 <- summarySE(data_clean, measurevar="PCK", groupvars="studiested2")
dc3 <- summarySE(data_clean, measurevar="TPACK", groupvars="studiested2")

# rename; kilde: https://www.statology.org/rename-single-column-in-r/
colnames(dc1)[colnames(dc1) == "TK"] <- "var"
colnames(dc2)[colnames(dc2) == "PCK"] <- "var"
colnames(dc3)[colnames(dc3) == "TPACK"] <- "var"

# merge data
dc <- rbind(dc1,dc2)
dc <- rbind(dc,dc3)

# add column med navn
dc["TPACK"] <- c("TK","TK","TK","PCK","PCK","PCK","TPACK","TPACK","TPACK")
```

```{r}
stolpediagram <- ggplot(dc, aes(x=studiested2, y=var, fill=studiested2)) + 
  geom_bar(stat="identity", position="dodge") +
  #scale_fill_manual(values=viridis(3)) + 
  geom_errorbar(aes(ymin=var-sd, ymax=var+sd), # se
                  linewidth=.3,    # Thinner lines
                  width=.2,
                  position=position_dodge(.9)) +
  ggtitle("PCK, TK og TPACK fordelt på studiested") +
  guides(fill="none") +
  # https://stackoverflow.com/questions/53843221/make-y-axis-start-at-1-instead-of-0-within-ggplot-bar-chart
#  coord_cartesian(ylim = c(1,5)) +
  ylab("verdi") +
  xlab("studiested gruppe") +
  theme_bw() +
  facet_wrap(~TPACK)

print(stolpediagram) # vis plot
```

```{r}
# save plot
if (plot_to_file) {
  ggsave("../output/TPACK_stolpediagram.png") #,height=8,width=15)
  }

```

```{r}
ggplot(dc, aes(x=TPACK, y=var, fill=studiested2)) + 
  geom_bar(stat="identity", position="dodge") +
  #scale_fill_manual(values=viridis(3)) + 
  geom_errorbar(aes(ymin=var-sd, ymax=var+sd), # se
                  linewidth=.3,    # Thinner lines
                  width=.2,
                  position=position_dodge(.9)) +
  ggtitle("PCK, TK og TPACK fordelt på studiested") +
  guides(fill="none") +
  # https://stackoverflow.com/questions/53843221/make-y-axis-start-at-1-instead-of-0-within-ggplot-bar-chart
#  coord_cartesian(ylim = c(1,5)) +
  ylab("verdi") +
  xlab("") +
  theme_bw() +
  facet_wrap(~studiested2)
```

## Check for interactions

### TK Level 1

```{r TK_gender_trinn}
# ref https://www.datanovia.com/en/blog/top-r-color-palettes-to-know-for-great-data-visualization/#viridis-color-palettes
# https://www.statology.org/interaction-plot-r/
interaction.plot(x.factor = factor(data_clean$Gender),
                 trace.factor = factor(data_clean$Trinn),
                 response = data_clean$TK,
                 type = "b",
                 ylab = "TK",
                 xlab = "Gender",
                 col = viridis(2), # c("pink", "blue"), 
                 trace.label = "Target grade level")
```

Different signs on slope, a clear indication of interaction effects on TK from gender and target grade level.

```{r TK_gender_semester}
# ref https://www.datanovia.com/en/blog/top-r-color-palettes-to-know-for-great-data-visualization/#viridis-color-palettes
# https://www.statology.org/interaction-plot-r/
interaction.plot(x.factor = factor(data_clean$Gender),
                 trace.factor = factor(data_clean$semester),
                 response = data_clean$TK,
                 type = "b",
                 ylab = "TK",
                 xlab = "Gender",
                 col = viridis(2), # c("pink", "blue"), 
                 trace.label = "Year of study")
```

```{r TK_semester_trinn}
# ref https://www.datanovia.com/en/blog/top-r-color-palettes-to-know-for-great-data-visualization/#viridis-color-palettes
# https://www.statology.org/interaction-plot-r/
interaction.plot(x.factor = factor(data_clean$Trinn),
                 trace.factor = factor(data_clean$semester),
                 response = data_clean$TK,
                 type = "b",
                 ylab = "TK",
                 xlab = "Target grade level",
                 col = viridis(2), # c("pink", "blue"), 
                 trace.label = "Year of study")
```

### TK Level 2

```{r TK_semester_institute}
interaction.plot(x.factor = factor(data_clean$semester), # label=c("Year 2/3", "Year 5")),
                 trace.factor = factor(data_clean$studiested), # label=c("institute 1", "institute 2", "institute 3", "institute 4", "institute 5")),
                 response = data_clean$TK,
                 type = "b",
                 ylab = "TK",
                 xlab = "Year of study",
                 col = viridis(5), # c("red", "green", "orange", "pink", "blue"),
                 trace.label = "Institute")
```

A clear interaction effect between institute and semester on TPACK.

```{r TK_trinn_institute}
interaction.plot(x.factor = factor(data_clean$Trinn), # label=c("Year 2/3", "Year 5")),
                 trace.factor = factor(data_clean$studiested), # label=c("institute 1", "institute 2", "institute 3", "institute 4", "institute 5")),
                 response = data_clean$TK,
                 type = "b",
                 ylab = "TK",
                 xlab = "Year of study",
                 col = viridis(5), # c("red", "green", "orange", "pink", "blue"),
                 trace.label = "Institute")
```

```{r TK_gender_institute}
interaction.plot(x.factor = factor(data_clean$Gender),
                 trace.factor = factor(data_clean$studiested), #label=c("institute 1", "institute 2", "institute 3", "institute 4", "institute 5")),
                 response = data_clean$TK,
                 type = "b",
                 ylab = "TK",
                 xlab = "Gender",
                 col = viridis(5), #c("red", "green", "orange", "pink", "blue"),
                 trace.label = "Institute")
```

### PCK Level 1

```{r PCK_gender_trinn}
# ref https://www.datanovia.com/en/blog/top-r-color-palettes-to-know-for-great-data-visualization/#viridis-color-palettes
# https://www.statology.org/interaction-plot-r/
interaction.plot(x.factor = factor(data_clean$Gender),
                 trace.factor = factor(data_clean$Trinn),
                 response = data_clean$PCK,
                 type = "b",
                 ylab = "PCK",
                 xlab = "Gender",
                 col = viridis(2), # c("pink", "blue"), 
                 trace.label = "Target grade level")
```

Different signs on slope, a clear indication of interaction effects on PCK from gender and target grade level.

```{r PCK_gender_semester}
# ref https://www.datanovia.com/en/blog/top-r-color-palettes-to-know-for-great-data-visualization/#viridis-color-palettes
# https://www.statology.org/interaction-plot-r/
interaction.plot(x.factor = factor(data_clean$Gender),
                 trace.factor = factor(data_clean$semester),
                 response = data_clean$PCK,
                 type = "b",
                 ylab = "PCK",
                 xlab = "Gender",
                 col = viridis(2), # c("pink", "blue"), 
                 trace.label = "Year of study")
```

```{r PCK_semester_trinn}
# ref https://www.datanovia.com/en/blog/top-r-color-palettes-to-know-for-great-data-visualization/#viridis-color-palettes
# https://www.statology.org/interaction-plot-r/
interaction.plot(x.factor = factor(data_clean$Trinn),
                 trace.factor = factor(data_clean$semester),
                 response = data_clean$PCK,
                 type = "b",
                 ylab = "PCK",
                 xlab = "Target grade level",
                 col = viridis(2), # c("pink", "blue"), 
                 trace.label = "Year of study")
```

### PCK Level 2

```{r PCK_semester_institute}
interaction.plot(x.factor = factor(data_clean$semester), # label=c("Year 2/3", "Year 5")),
                 trace.factor = factor(data_clean$studiested), # label=c("institute 1", "institute 2", "institute 3", "institute 4", "institute 5")),
                 response = data_clean$PCK,
                 type = "b",
                 ylab = "PCK",
                 xlab = "Year of study",
                 col = viridis(5), # c("red", "green", "orange", "pink", "blue"),
                 trace.label = "Institute")
```

A clear interaction effect between institute and semester on TPACK.

```{r PCK_trinn_institute}
interaction.plot(x.factor = factor(data_clean$Trinn), # label=c("Year 2/3", "Year 5")),
                 trace.factor = factor(data_clean$studiested), # label=c("institute 1", "institute 2", "institute 3", "institute 4", "institute 5")),
                 response = data_clean$PCK,
                 type = "b",
                 ylab = "PCK",
                 xlab = "Year of study",
                 col = viridis(5), # c("red", "green", "orange", "pink", "blue"),
                 trace.label = "Institute")
```

```{r PCK_gender_institute}
interaction.plot(x.factor = factor(data_clean$Gender),
                 trace.factor = factor(data_clean$studiested), #label=c("institute 1", "institute 2", "institute 3", "institute 4", "institute 5")),
                 response = data_clean$PCK,
                 type = "b",
                 ylab = "PCK",
                 xlab = "Gender",
                 col = viridis(5), #c("red", "green", "orange", "pink", "blue"),
                 trace.label = "Institute")
```

### TPACK Level 1

```{r TPACK_gender_trinn}
# https://www.statology.org/interaction-plot-r/
interaction.plot(x.factor = factor(data_clean$Gender),
                 trace.factor = factor(data_clean$Trinn),
                 response = data_clean$TPACK,
                 type = "b",
                 ylab = "TPACK",
                 xlab = "Gender",
                 col = viridis(2), # c("pink", "blue"),
                 trace.label = "Target grade level")
```

Not so clear interaction effect, similar slopes? They do cross eventually. 

```{r TPACK_gender_semester}
# https://www.statology.org/interaction-plot-r/
interaction.plot(x.factor = factor(data_clean$Gender),
                 trace.factor = factor(data_clean$semester),
                 response = data_clean$TPACK,
                 type = "b",
                 ylab = "TPACK",
                 xlab = "Gender",
                 col = viridis(2), # c("pink", "blue"),
                 trace.label = "Study year")
```

```{r TPACK_trinn_semester}
# https://www.statology.org/interaction-plot-r/
interaction.plot(x.factor = factor(data_clean$Trinn),
                 trace.factor = factor(data_clean$semester),
                 response = data_clean$TPACK,
                 type = "b",
                 ylab = "TPACK",
                 xlab = "Target grade level",
                 col = viridis(2), # c("pink", "blue"),
                 trace.label = "Study year")
```

### TPACK Level 2

```{r TPACK_semester_institute}
interaction.plot(x.factor = factor(data_clean$semester), # label=c("Year 2/3", "Year 5")),
                 trace.factor = factor(data_clean$studiested), # label=c("institute 1", "institute 2", "institute 3", "institute 4", "institute 5")),
                 response = data_clean$TPACK,
                 type = "b",
                 ylab = "TPACK",
                 xlab = "Year of study",
                 col = viridis(5), # c("red", "green", "orange", "pink", "blue"),
                 trace.label = "Institute")
```

A clear interaction effect between institute and semester on TPACK.

```{r TPACK_trinn_institute}
interaction.plot(x.factor = factor(data_clean$Trinn), # label=c("Year 2/3", "Year 5")),
                 trace.factor = factor(data_clean$studiested), # label=c("institute 1", "institute 2", "institute 3", "institute 4", "institute 5")),
                 response = data_clean$TPACK,
                 type = "b",
                 ylab = "TPACK",
                 xlab = "Year of study",
                 col = viridis(5), # c("red", "green", "orange", "pink", "blue"),
                 trace.label = "Institute")
```

```{r TPACK_gender_institute}
interaction.plot(x.factor = factor(data_clean$Gender),
                 trace.factor = factor(data_clean$studiested), #label=c("institute 1", "institute 2", "institute 3", "institute 4", "institute 5")),
                 response = data_clean$TPACK,
                 type = "b",
                 ylab = "TPACK",
                 xlab = "Gender",
                 col = viridis(5), #c("red", "green", "orange", "pink", "blue"),
                 trace.label = "Institute")
```

Not so clear interaction on TPACK from gender and institute.

# Regression analysis

## Check assumptions for regression

```{r normality}
# covariates; 80/20 distribution
# ref http://stackoverflow.com/questions/21639392/ddg#21639445
barplot(prop.table(table(data_clean$Gender)))
barplot(prop.table(table(data_clean$Trinn)))
barplot(prop.table(table(data_clean$semester)))
#hist(oslomet_r)
#hist(innlandet_r)
#hist(HVL_r)
#hist(UIT_r)

# variable
hist(data_clean$TK)
hist(data_clean$PCK)
hist(data_clean$TPACK)
```

```{r}
describe_data(data_clean$TK)
describe_data(data_clean$PCK)
describe_data(data_clean$TPACK)
```

```{r scatterplot_linearity, eval=F}
plot(data_clean$Gender,        data_clean$TPACK)
plot(data_clean$Trinn,         data_clean$TPACK)
plot(data_clean$semester,      data_clean$TPACK)
#plot(data_clean$oslomet_r,         data_clean$TPACK_v23)
#plot(data_clean$innlandet_r,       data_clean$TPACK_v23)
#plot(data_clean$HVL_r,             data_clean$TPACK_v23)
#plot(data_clean$UIT_r,             data_clean$TPACK_v23)

plot(data_clean$TK,            data_clean$TPACK)
#plot(data_clean$TK[oslomet_r],data_clean$TPACK[oslomet_r]) # gr.A
#plot(data_clean$TK[innlandet_r],data_clean$TPACK[innlandet_r]) # gr.B
#plot(data_clean$TK[HVL_r],data_clean$TPACK[HVL_r]) # gr.A
#plot(data_clean$TK[UIT_r],data_clean$TPACK[UIT_r]) # gr.B

#scatterplot(TPACK_regdata, c("TK", "TPACK"), factor(studiested))
#scatterplot(TPACK_regdata, c("TK", "TPACK"), factor(semester))

plot(data_clean$PCK,           data_clean$TPACK)
```

```{r multicollinearity, eval=F}
#cor(TK_v23, studiested_r)
#cor(PCK_v23, studiested_r)
cor(data_clean$PCK,   data_clean$semester)
#cor(TPACK_v23, studiested_r)
cor(data_clean$TPACK, data_clean$Gender)

cor(data_clean$TK,    data_clean$Gender)
cor(data_clean$TK,    data_clean$Trinn)

cor(data_clean$TK,    data_clean$PCK)
cor(data_clean$TK,    data_clean$TPACK)
cor(data_clean$PCK,   data_clean$TPACK)
```

TK korrelererer veldig sterkt (0.84) med TPACK, noe som indikerer kollinearitet. (Jeong and Jung, 2016)

## Hierarchical RA for TK

Level 1: students  
Level 2: institution

We are using cluster corrected standard errors to correct for clustering on institution.

Add student covariates

### Level 1

```{r TKlevel1_main}
# kovariater; we use scale to standardize when using interaction effects
# sjekk: er det riktig å skalere?
m1 <- lm_robust(TK ~ factor(Gender) + (factor(Trinn) + factor(semester)), 
                clusters = factor(studiested), data=data_clean)
summary(m1)
```

```{r TKlevel1_interaction}
# kovariater; we use scale to standardize when using interaction effects
# sjekk: er det riktig å skalere?
m2 <- lm_robust(scale(TK, center=T, scale=T) ~ factor(Gender) * (factor(Trinn) + factor(semester)), 
                clusters = factor(studiested), data=data_clean)
summary(m2)
```

Calculate F-stat to see if they are significantly different

```{r}
# source: https://www.statology.org/how-to-calculate-the-p-value-of-an-f-statistic-in-r/
# source: p. 257 i Howitt & Cramer, 2014
fstat <- m2$adj.r.squared / m1$adj.r.squared
df1 <- length(data_clean$TK) - 1
df2 <- df1
pf(fstat, df1, df2, lower.tail = FALSE)
```

### Level 2

```{r TKlevel2_main}
# studiested; HVL velges som referansekategori siden den har lavest TPACK-verdi av alle
m3 <- lm_robust(scale(TK) ~ factor(Gender) * (factor(Trinn) + factor(semester)) +        # level 1
                               factor(studiested) + (factor(semester) + factor(Trinn) + factor(Gender)),    # level 2
                clusters = factor(studiested), data=data_clean)
summary(m3)
```

```{r}
# main
fstat <- m3$adj.r.squared / m1$adj.r.squared
pf(fstat, df1, df2, lower.tail = FALSE)

# interaction
fstat <- m3$adj.r.squared / m2$adj.r.squared
pf(fstat, df1, df2, lower.tail = FALSE)
```

```{r TKlevel2_interaction}
# studiested; HVL velges som referansekategori siden den har lavest TPACK-verdi av alle
m4 <- lm_robust(scale(TK) ~ factor(Gender) * (factor(Trinn) + factor(semester)) +        # level 1
                               factor(studiested) * (factor(semester) + factor(Trinn) + factor(Gender)),    # level 2
                clusters = factor(studiested), data=data_clean)
summary(m4)
```

```{r}
# interaction
fstat <- m4$adj.r.squared / m3$adj.r.squared
pf(fstat, df1, df2, lower.tail = FALSE)
```

## Hierarchical RA for PCK

Level 1: students  
Level 2: institution

We are using cluster corrected standard errors to correct for clustering on institution.

Add student covariates

### Level 1

```{r PCKlevel1_main}
# kovariater; we use scale to standardize when using interaction effects
# sjekk: er det riktig å skalere?
m1 <- lm_robust(PCK ~ factor(Gender) + (factor(Trinn) + factor(semester)), 
                clusters = factor(studiested), data=data_clean)
summary(m1)
```

```{r PCKlevel1_interaction}
# kovariater; we use scale to standardize when using interaction effects
# sjekk: er det riktig å skalere?
m2 <- lm_robust(scale(PCK, center=T, scale=T) ~ factor(semester) * (factor(Gender) + factor(Trinn)), 
                clusters = factor(studiested), data=data_clean)
summary(m2)
```

Calculate F-stat to see if they are significantly different

```{r}
# source: https://www.statology.org/how-to-calculate-the-p-value-of-an-f-statistic-in-r/
# source: p. 257 i Howitt & Cramer, 2014
fstat <- m2$adj.r.squared / m1$adj.r.squared
df1 <- length(data_clean$PCK) - 1
df2 <- df1
pf(fstat, df1, df2, lower.tail = FALSE)
```

### Level 2

```{r PCKlevel2_main}
# studiested; HVL velges som referansekategori siden den har lavest TPACK-verdi av alle
m3 <- lm_robust(scale(PCK) ~ factor(Gender) * (factor(Trinn) + factor(semester)) +        # level 1
                               factor(studiested) + (factor(semester) + factor(Trinn) + factor(Gender)),    # level 2
                clusters = factor(studiested), data=data_clean)
summary(m3)
```

```{r}
# main
fstat <- m3$adj.r.squared / m1$adj.r.squared
pf(fstat, df1, df2, lower.tail = FALSE)

# interaction
fstat <- m3$adj.r.squared / m2$adj.r.squared
pf(fstat, df1, df2, lower.tail = FALSE)
```

```{r PCKlevel2_interaction}
# studiested; HVL velges som referansekategori siden den har lavest TPACK-verdi av alle
m4 <- lm_robust(scale(PCK) ~ factor(Gender) * (factor(Trinn) + factor(semester)) +        # level 1
                               factor(studiested) * (factor(semester) + factor(Trinn) + factor(Gender)),    # level 2
                clusters = factor(studiested), data=data_clean)
summary(m4)
```

```{r}
fstat <- m4$adj.r.squared / m3$adj.r.squared
pf(fstat, df1, df2, lower.tail = FALSE)
```


## Hierarchical RA for TPACK

Level 1: students  
Level 2: institution

We are using cluster corrected standard errors to correct for clustering on institution.

Add student covariates

### Level 1

```{r level1_main}
# kovariater; we use scale to standardize when using interaction effects
# sjekk: er det riktig å skalere?
m1 <- lm_robust(TPACK ~ factor(Gender) + (factor(Trinn) + factor(semester)), 
                clusters = factor(studiested), data=data_clean)
summary(m1)
```

```{r level1_interaction}
# kovariater; we use scale to standardize when using interaction effects
# sjekk: er det riktig å skalere?
m2 <- lm_robust(scale(TPACK, center=T, scale=T) ~ factor(Gender) * (factor(Trinn) + factor(semester)), 
                clusters = factor(studiested), data=data_clean)
summary(m2)
```

Calculate F-stat to see if they are significantly different

```{r}
# source: https://www.statology.org/how-to-calculate-the-p-value-of-an-f-statistic-in-r/
# source: p. 257 i Howitt & Cramer, 2014
fstat <- m2$adj.r.squared / m1$adj.r.squared
df1 <- length(data_clean$TPACK) - 1
df2 <- df1
pf(fstat, df1, df2, lower.tail = FALSE)
```


### Level 2

```{r level2_main}
# studiested; HVL velges som referansekategori siden den har lavest TPACK-verdi av alle
m3 <- lm_robust(scale(TPACK) ~ factor(Gender) * (factor(Trinn) + factor(semester)) +        # level 1
                               factor(studiested) + (factor(semester) + factor(Gender)),    # level 2
                clusters = factor(studiested), data=data_clean)
summary(m3)

#main
fstat <- m3$adj.r.squared / m1$adj.r.squared
pf(fstat, df1, df2, lower.tail = FALSE)

# interaction
fstat <- m3$adj.r.squared / m2$adj.r.squared
pf(fstat, df1, df2, lower.tail = FALSE)
```

```{r level2_interaction}
# studiested; HVL velges som referansekategori siden den har lavest TPACK-verdi av alle
m4 <- lm_robust(scale(TPACK) ~ factor(Gender) * (factor(Trinn) + factor(semester)) +        # level 1
                               factor(studiested) * (factor(semester) + factor(Gender)),    # level 2
                clusters = factor(studiested), data=data_clean)
summary(m4)

fstat <- m4$adj.r.squared / m3$adj.r.squared
pf(fstat, df1, df2, lower.tail = FALSE)
```

### PCK

```{r PCK}
# PCK
m5 <- lm_robust(scale(TPACK) ~ factor(Gender) * (factor(Trinn) + factor(semester)) +         # level 1
                        factor(studiested) * (factor(semester) + factor(Gender)) +    # level 2
                        scale(PCK), 
                clusters = factor(studiested), data=data_clean)
summary(m5)

# main
fstat <- m5$adj.r.squared / m3$adj.r.squared
pf(fstat, df1, df2, lower.tail = FALSE)

# interaction
fstat <- m5$adj.r.squared / m4$adj.r.squared
pf(fstat, df1, df2, lower.tail = FALSE)
```

### TK

```{r TK}
# TK
m6 <- lm_robust(scale(TPACK) ~ factor(Gender) * (factor(Trinn) + factor(semester)) +        # level 1
                        factor(studiested) * (factor(semester) + factor(Gender)) +    # level 2
                        scale(PCK) + scale(TK), 
                clusters = factor(studiested), data=data_clean)
summary(m6)

fstat <- m6$adj.r.squared / m5$adj.r.squared
pf(fstat, df1, df2, lower.tail = FALSE)
```

